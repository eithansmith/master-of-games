{{ define "week" }}
    {{ template "base" . }}
{{ end }}

{{ define "main" }}
    <section class="card">
        <!--suppress UnnecessaryLabelJS -->
        <div class="row"
             style="gap: 8px; align-items: center;"
             x-data="{
                year: parseInt('{{ .Year }}'),
                week: parseInt('{{ .Week }}'),
            }"
        >

            <a class="btn secondary" href="/weeks/current">Current</a>

            <!--suppress BadExpressionStatementJS, JSUndeclaredVariable, JSUnresolvedReference -->
            <button class="btn secondary"
                    @click="() => {
                        week = week - 1;
                        if (week < 1) {
                            week = 52;
                            year = year - 1;
                        }
                        window.location = `/weeks/${year}/${week}`
                    }"
                    title="Previous week">
                ‚Üê
            </button>

            <div style="display:flex; gap:8px; align-items:center;">

                <label style="display:flex; gap:6px; align-items:center;">
                    <span class="hint">Year</span>
                    <select x-model="year"
                            @change="window.location = `/weeks/${year}/${week}`">
                        {{ range .Years }}
                            <option value="{{ . }}">{{ . }}</option>
                        {{ end }}
                    </select>
                </label>

                <label style="display:flex; gap:6px; align-items:center;">
                    <span class="hint">Week</span>
                    <select x-model="week"
                            @change="window.location = `/weeks/${year}/${week}`">
                        {{ range .Weeks }}
                            <option value="{{ . }}">
                                {{ printf "%02d" . }}
                            </option>
                        {{ end }}
                    </select>
                </label>

            </div>

            <!--suppress BadExpressionStatementJS -->
            <button
                    class="btn secondary"
                    @click="() => {
                        week = week + 1;
                        if (week > 52) {
                            week = 1;
                            year = year + 1;
                        }
                        window.location = `/weeks/${year}/${week}`
                    }"
                    title="Next week">
                ‚Üí
            </button>
        </div>

        {{ if .FormError }}
            <div class="alert">{{ .FormError }}</div>
        {{ end }}

        {{ if eq .TotalGames 0 }}
            <p style="margin-top: 10px;">No Trophy Awarded ‚Äî no games played (Mon ‚Äì Fri).</p>
        {{ else }}
            <div style="margin-top: 10px;">
                <div class="label">This week‚Äôs trophy</div>

                {{ if .WinnerID }}
                    <div class="trophy">
                        üèÜ {{ index .PlayerNames (derefInt64 .WinnerID) }}
                    </div>
                {{ else }}
                    <div class="trophy">
                        ü§ù Tie (unresolved)
                    </div>

                    <p class="hint" style="margin-top: 8px;">
                        Tied leaders:
                        {{ range $i, $pid := .TopIDs }}{{ if $i }}, {{ end }}{{range $.Players}}{{if eq .ID $pid}}{{.Name}}{{end}}{{end}}{{ end }}
                    </p>

                    <form hx-post="/weeks/{{ .Year }}/{{ .Week }}/tiebreak"
                          hx-target="#main"
                          hx-swap="innerHTML"
                          method="post"
                          style="margin-top: 10px;">

                        <label>
                            Resolve by Game of Chance ‚Äî choose winner:
                            <select name="winner_id" required>
                                <option value="">Select...</option>
                                {{ range $i, $pid := .TopIDs }}
                                    {{range $.Players}}
                                        {{if eq .ID $pid}}
                                        <option value="{{ .ID }}">{{.Name}}</option>{{end}}
                                    {{end}}
                                {{ end }}
                            </select>
                        </label>

                        <div class="row">
                            <button class="btn" type="submit">Record tiebreaker</button>
                        </div>
                    </form>
                {{ end }}

                <p class="hint">Total games (Mon ‚Äì Fri): <strong>{{ .TotalGames }}</strong></p>
            </div>
        {{ end }}
    </section>

    <section class="card" style="margin-top: 12px;">
        <h1>Wins</h1>

        <div class="list">
            {{ range .Players }}
                <div class="list-item">
                    <div class="li-main">
                        <div class="li-title">{{ .Name }}</div>
                        <div class="li-sub">
                            Wins:
                            {{ $w := index $.Wins .ID }}
                            {{ if $w }}{{ $w }}{{ else }}0{{ end }}
                        </div>
                    </div>
                </div>
            {{ end }}
        </div>
    </section>
{{ end }}
